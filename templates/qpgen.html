{% extends 'base.html' %}

{% block title %}Generated Questions{% endblock %}


{% block section %}

<style>
    * {
        outline: red solid 1px;
    }
    .container {
        background-color: white;
        display: flex;
        height: 90vh;
        margin: 2%;
        border-radius: 20px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .container-sidebar {
        width: 30%;
        padding: 20px;
        border-right: 1px solid #e0e0e0;
        overflow-y: auto;
    }

    .question-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .question-item {
        background-color: #f8f9fa;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .question-item:hover {
        cursor: pointer;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .question-content {
        display: flex;
        align-items: center;
        padding: 10px;
    }

    .thumbnail {
        width: 80px;
        height: 80px;
        flex-shrink: 0;
        margin-right: 15px;
        overflow: hidden;
        border-radius: 8px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .question-info {
        flex-grow: 1;
    }

    .question-info h4 {
        margin: 0;
        font-size: 1.1rem;
        color: #333;
    }

    .question-info h5 {
        margin: 5px 0 0;
        font-size: 0.9rem;
        color: #666;
    }

    .content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .question-container {
        display: none;
        flex-direction: column;
        height: 100%;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f0f0f0;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .question-details {
        display: flex;
        gap: 20px;
    }

    .detail-item {
        font-size: 0.9rem;
        color: #555;
    }

    .toggle-solution-btn, .pagination button {
        padding: 8px 16px;
        background-color: #5d71e0;
        cursor: pointer;
        color: #ffffff;
        font-size: 0.9rem;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s ease;
    }

    .toggle-solution-btn:hover, .pagination button:hover {
        background-color: #4a5cba;
    }

    .image-container {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        width: 100%;
        height: calc(100% - 70px); /* Subtracting top-bar height */
    }

    .image-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .solution-container {
        display: none;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }

    .pagination button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    .pagination span {
        margin: 0 10px;
        color: #333;
        font-size: 0.9rem;
    }

    .solution-not-found {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        font-size: 1.5rem;
        color: #666;
    }
</style>

<div class="container">
    <div class="container-sidebar">
        <h2 style="margin-bottom: 20px; font-size: 1.5rem;">
            <span class="blue-highlight">{{ rows|length }}</span> Questions Generated
        </h2>
        <div class="question-list">
            {% for row in rows %}
            <div class="question-item" data-id="{{row.1}}" data-topic="{{row.3}}" data-difficulty="{{row.4}}" data-component="{{row.7}}">
                <div class="question-content">
                    <div class="thumbnail">
                        <div class="question-image" data-compressed="{{ row[8] }}"></div>
                    </div>
                    <div class="question-info">
                        <h4 class="blue-highlight">{{row.3}}</h4>
                        <h5 class="pink-highlight">{{row.7}}</h5>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="pagination">
            <button id="prevPage" disabled>Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button id="nextPage">Next</button>
        </div>
    </div>
    <div class="content">
        {% for row in rows %}
        <div class="question-container" id="question-container-{{row.1}}">
            <div class="top-bar">
                <div class="question-details">
                    <span class="detail-item">Topic: <strong>{{row.3}}</strong></span>
                    <span class="detail-item">Difficulty: <strong>{{row.4}}</strong></span>
                    <span class="detail-item">Component: <strong>{{row.7}}</strong></span>
                </div>
                <button class="toggle-solution-btn" data-id="{{row.1}}">Show Solution</button>
            </div>
            <div class="image-container question-image" data-id="{{row.1}}" data-compressed="{{ row[8] }}"></div>

            <div class="image-container solution-container" id="solution-container-{{row.1}}">
                <div class="solution-image" data-id="{{row.1}}" data-compressed="{{ row[9] }}"></div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function renderImageFromElement(element, base64Data) {
            if (!element || !base64Data) {
                console.error("Element or data not found");
                return;
            }

            try {
                const binaryString = atob(base64Data);
                const charData = binaryString.split('').map(char => char.charCodeAt(0));
                const uint8Array = new Uint8Array(charData);
                const decompressedData = pako.inflate(uint8Array);
                const blob = new Blob([decompressedData], { type: 'image/png' });
                const imageUrl = URL.createObjectURL(blob);

                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                element.textContent = '';
                element.appendChild(imgElement);
            } catch (error) {
                console.error(`Failed to render image for element ID ${element.id}:`, error);
            }
        }

        const questionImages = document.querySelectorAll('.question-image');
        const solutionImages = document.querySelectorAll('.solution-image');

        questionImages.forEach((element) => {
            const base64Data = element.getAttribute('data-compressed');
            renderImageFromElement(element, base64Data);
        });

        solutionImages.forEach((element) => {
            const base64Data = element.getAttribute('data-compressed');
            renderImageFromElement(element, base64Data);
        });

        const questionItems = document.querySelectorAll('.question-item');
        const questionContainers = document.querySelectorAll('.question-container');

        // Pagination
        const itemsPerPage = 6;
        let currentPage = 1;
        const totalPages = Math.ceil(questionItems.length / itemsPerPage);

        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');

        function showPage(page) {
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;

            questionItems.forEach((item, index) => {
                item.style.display = (index >= start && index < end) ? 'block' : 'none';
            });

            prevPageBtn.disabled = (page === 1);
            nextPageBtn.disabled = (page === totalPages);
            pageInfo.textContent = `Page ${page} of ${totalPages}`;
        }

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
            }
        });

        // Toggling question containers
        questionItems.forEach(item => {
            item.addEventListener('click', () => {
                const questionId = item.getAttribute('data-id');
                const questionContainer = document.querySelector(`#question-container-${questionId}`);

                questionContainers.forEach(container => container.style.display = 'none');
                questionContainer.style.display = 'flex';
            });
        });

        // Click on the first question
        const firstQuestionItem = document.querySelector('.question-item');
        if (firstQuestionItem) {
            firstQuestionItem.click();
        }

        // Toggling solution containers
        const solutionButtons = document.querySelectorAll('.toggle-solution-btn');

        solutionButtons.forEach(button => {
            button.addEventListener('click', function () {
                const buttonId = button.getAttribute('data-id');
                const solutionContainer = document.querySelector(`#solution-container-${buttonId}`);
                const questionImage = document.querySelector(`.question-image[data-id="${buttonId}"]`);

                if (solutionContainer.style.display === 'none' || !solutionContainer.style.display) {
                    solutionContainer.style.display = 'flex';
                    questionImage.style.display = 'none';
                    button.textContent = 'Hide Solution';

                    // Check if solution is not found
                    const solutionImage = solutionContainer.querySelector('.solution-image');
                    if (solutionImage && !solutionImage.querySelector('img')) {
                        solutionImage.innerHTML = '<div class="solution-not-found">Solution not found!</div>';
                    }
                } else {
                    solutionContainer.style.display = 'none';
                    questionImage.style.display = 'flex';
                    button.textContent = 'Show Solution';
                }
            });
        });

        // Initialize pagination
        showPage(currentPage);
    });
</script>
{% endblock %}